# Install TKG Management Cluster

Follow the [official docs](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.2/vmware-tanzu-kubernetes-grid-12/GUID-install-tkg.html) for background and pre-requisite tasks, which includes downloading tkg cli from my.vmware.com and links for kubectl and docker setup.  Although not required, it is helpful to have the [kind](https://github.com/kubernetes-sigs/kind) cli installed.

Then Follow the next section that applies for your environment: AWS or vSphere. These instructions are based on the official docs steps that use the CLI. Alternatively you can use the Installer Interface and have the config file autogenerated with correct & well formatted values.

## Install TKG Management Cluster on AWS

1. Complete [Deploy Management Clusters to Amazon EC2](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.2/vmware-tanzu-kubernetes-grid-12/GUID-mgmt-clusters-aws.html) which does setup activity in EC2. In this step, the docs will walk you through setting environment variables, and creating a key pair.  However, if you would like to use our scripted approach, you simply need to ensure you have populated your `params.yaml` file.  At that point, you can use the following script.  The private key will be stored in the `keys` directory.

```bash
./scripts/01-prep-aws-objects.sh
```

2. Follow steps from [Deploy the Management Cluster to Amazon EC2 with the CLI](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.2/vmware-tanzu-kubernetes-grid-12/GUID-mgmt-clusters-aws-cli.html) up to the `tkg init` command. Then you can use our script below to execute the required steps to create the management cluster.  Your only manual action is to prepare the `.tkg/config.yaml` file.  For this you can also use the `REDACTED-config.yaml` located at the root of this repo as a reference of what a given config.yaml ended up looking like after the tasks described in the docs. Run this script to complete the deployment.

```bash
./scripts/02-deploy-aws-mgmt-cluster.sh
```

>Note: This step takes about 12 minutes.  You have an opportunity here to skip ahead to [Step 3: Configure DNS and Prep Certificate Signing](03_dns_certs_mgmt.md), [Step 4: Configure Okta](04_okta_mgmt.md), and [Step 5: Retrieve TKG Extensions](05_extensions_mgmt.md) to complete steps in parallel.  Then you can come back and finish off this step.

3. At this point the management cluster is deployed.  We will be adding a few additional components such that we would benefit from two worker nodes in the cluster. The following script will perform these actions.

```bash
./scripts/03-post-deploy-mgmt-cluster.sh
```

4. Validation Step. Check management cluster is provisioned, pods are running:

```bash
tkg get management-clusters
kubectl get pods -A
```

## Install TKG Management Cluster on vSphere

1. Complete [Deploy Management Clusters to vSphere](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.2/vmware-tanzu-kubernetes-grid-12/GUID-mgmt-clusters-vsphere.html) which prepares an SSH key and the OS image templates to be used for all clusters.

First thing you need to do is to download the VMware Tanzu Kubernetes Grid 1.2.0 OVAs for Kubernetes from https://www.vmware.com/go/get-tkg. You need to download v1.19.1 for the management cluster and optionally the others if you choose to deploy workload clusters with a different version of Kubernetes:

- Photon v3 Kubernetes v1.19.1 OVA (our scripts will only use this version)
- Photon v3 Kubernetes v1.18.8 OVA
- Photon v3 Kubernetes v1.17.11 OVA

Then you can follow the manual steps in the documentation or use the following script to automate the creation of the SSH key, upload OVAs and set as template. SSH keys will be stored at `keys/tkg_rsa` and `keys/tkg_rsa.pub`.

You'll need to install [govc](https://github.com/vmware/govmomi/tree/master/govc#installation). You'll also need to fill the `vsphere` configuration block of the `params.yaml` file with the values from your vSphere environment and local folders. Then run this script:

```bash
./scripts/01-prep-vsphere-objects.sh
```

2. Follow steps from [Deploy the Management Cluster to vSphere with the CLI](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.2/vmware-tanzu-kubernetes-grid-12/GUID-mgmt-clusters-vsphere-cli.html) up to the `tkg init` command. Then you can use our script below to execute the required steps to create the management cluster.  Your only manual action is to prepare the `.tkg/config.yaml` file.  For this you can also use the `REDACTED-config.yaml` located at the root of this repo as a reference of what a given config.yaml ended up looking like after the tasks described in the docs. Run this script to complete the deployment.

```bash
./scripts/02-deploy-vsphere-mgmt-cluster.sh
```

>Note: This step takes about 12 minutes.  You have an opportunity here to skip ahead to [Step 3: Configure DNS and Prep Certificate Signing](03_dns_certs_mgmt.md), [Step 4: Configure Okta](04_okta_mgmt.md), and [Step 5: Retrieve TKG Extensions](05_extensions_mgmt.md) to complete steps in parallel.  Then you can come back and finish off this step.

3. At this point the management cluster is deployed.  We will be adding a few additional components such that we would benefit from two worker nodes in the cluster. The following script will perform these actions:s

```bash
./scripts/03-post-deploy-mgmt-cluster.sh
```

4. Validation Step. Check management cluster is provisioned, pods are running:

```bash
tkg get management-clusters
kubectl get pods -A
```

## Go to Next Step

[Attach Management Cluster to TMC](02_attach_tmc_mgmt.md)
